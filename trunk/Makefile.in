# $Id$

# ESOS Makefile[.in]
# Makefile is generated from Makefile.in via the configure script.
# Please see the README/INSTALL documents for help.

CWD		:= $(shell pwd)
WORK_DIR	:= $(CWD)/work
DISTFILES_DIR	:= $(WORK_DIR)/distfiles
BUILD_DIR	:= $(WORK_DIR)/build
IMAGE_DIR	:= $(WORK_DIR)/image
INITRAMFS_DIR	:= $(WORK_DIR)/initramfs
MOUNT_DIR	:= $(WORK_DIR)/mnt

QUIET		:= @
STRIP		:= -s

WGET		:= @wget@ -t 5
MKDIR		:= @mkdir@ -p
RM		:= @rm@ -rf
TAR		:= @tar@
UNZIP		:= @unzip@
CP		:= @cp@ -L
FIND		:= @find@
CPIO		:= @cpio@
GZIP		:= @gzip@ -9
ECHO		:= @echo@
SFDISK		:= @sfdisk@
CAT		:= @cat@
TEST		:= @test@
GREP		:= @grep@
DD		:= @dd@
MKE2FS		:= @mke2fs@
LN		:= @ln@ -sf
MOUNT		:= @mount@
UMOUNT		:= @umount@
SED		:= @sed@
MKNOD		:= @mknod@
TOUCH		:= @touch@
RPM2CPIO	:= @rpm2cpio@
INSTALL		:= @install@ -c
PATCH		:= @patch@
CHOWN		:= @chown@
CHMOD		:= @chmod@
MD5SUM		:= @md5sum@ -w
SHA256SUM	:= @sha256sum@ -w
SLEEP		:= @sleep@

esos_ver	:= 0.1-r$(shell svnversion $(CWD))
prod_suffix	:= -esos.prod
debug_suffix	:= -esos.debug

distfiles	= $(addprefix $(DISTFILES_DIR)/, \
		busybox-1.19.0.tar.bz2 \
		grub-1.99.tar.gz \
		sysvinit-2.88dsf.tar.bz2 \
		glibc-2.12.2.tar.bz2 \
		vixie-cron-4.1.tar.bz2 \
		libibumad-1.3.7.tar.gz \
		libibverbs-1.1.4.tar.gz \
		srptools-0.0.4.tar.gz \
		openssh-5.8p1.tar.gz \
		ssmtp-2.64.tar.bz2 \
		perl-5.12.4.tar.bz2 \
		openssl-1.0.0e.tar.gz \
		e2fsprogs-1.41.14.tar.gz \
		zlib-1.2.5.tar.bz2 \
		lsscsi-0.25.tar.gz \
		sg3_utils-1.33.tar.gz \
		groff-1.21.tar.gz \
		ncurses-5.7.tar.gz \
		qlogic_fw-20120101.tar.gz \
		linux-3.2.6.tar.bz2 \
		scst-trunk_r4130.tar.bz2 \
		kexec-tools-2.0.3.tar.gz \
		gcc-4.4.5.tar.bz2)
distfiles_repo	= http://enterprise-storage-os.googlecode.com/files

no_fetch_pkg_1		= $(addprefix $(DISTFILES_DIR)/,8.02.16_MegaCLI.zip)
no_fetch_pkg_1_url	= http://www.lsi.com/search/Pages/downloads.aspx?k=8.02.16_MegaCLI.zip

no_fetch_pkg_2		= $(addprefix $(DISTFILES_DIR)/,asm_linux_x64_v7_30_18837.tgz)
no_fetch_pkg_2_url	= http://www.adaptec.com/en-us/speed/raid/storage_manager/asm_linux_x64_v7_30_18837_tgz.htm

build_targets		:= scst_kernel$(prod_suffix) scst_kernel$(debug_suffix) \
			busybox sysvinit grub glibc perl MegaCLI qlogic_fw \
			scstadmin openssh vixie-cron gcc openssl zlib ncurses \
			e2fsprogs ssmtp libibumad libibverbs srptools asm_linux \
			lsscsi sg3_utils groff kexec-tools
clean_targets		:= $(addprefix clean-,$(build_targets))
src_dir			= $(wildcard $(BUILD_DIR)/$(@)-*)
tarball_src_dirs	= $(addprefix $(BUILD_DIR)/,$(subst .tar.bz2,,$(subst .tar.gz,,$(notdir $(distfiles)))))

export LDFLAGS = -L$(IMAGE_DIR)/lib -L$(IMAGE_DIR)/usr/lib
export CPPFLAGS = -I$(IMAGE_DIR)/usr/include


# all - The default goal; complete every target except install.
.PHONY: all
all: fetch extract build ;


# install - Prompt for USB thumb-drive device node and install the distribution to it.
.PHONY: install
install: install_dev_node = $(WORK_DIR)/install_dev_node
install: usb_device = $$($(CAT) $(install_dev_node))
install: initramfs
	$(QUIET) if [ `whoami` != "root" ]; then \
	  $(ECHO) "### Snap! Ya gotta be root for this part..."; \
	  exit 1; \
	fi
	$(QUIET) $(ECHO) "### Please type the full path of your USB drive device node (eg, /dev/sdz):" &&	\
	read dev_node && $(ECHO) -n $$dev_node > $(install_dev_node)
	$(QUIET) $(ECHO) && $(ECHO)
	$(QUIET) if [ "$(usb_device)" = "" ] || [ ! -e $(usb_device) ]; then \
	  $(ECHO) "### That device node doesn't seem to exist."; \
	  exit 1; \
	fi
	$(QUIET) if $(GREP) $(usb_device) /proc/mounts > /dev/null; then \
	  $(ECHO) "### It looks like that device is mounted..."; \
	  exit 1; \
	fi
	$(QUIET) if [ `$(SFDISK) -s $(usb_device)` -lt 3900000 ]; then \
	  $(ECHO) "### Your USB flash drive isn't large enough; it must be at least 4 GB."; \
	  exit 1; \
	fi
	$(QUIET) $(ECHO) "### This is what '$(usb_device)' looks like..."
	$(QUIET) $(SFDISK) -l $(usb_device)
	$(QUIET) $(ECHO) && $(ECHO)
	$(QUIET) $(ECHO) "### Proceeding will completely wipe the above device! Are you sure (Yes)?" &&	\
	read confirm && $(TEST) $$confirm = "Yes"
	$(QUIET) $(ECHO) && $(ECHO)
	$(QUIET) $(ECHO) "### Saving MBR / partition table for $(usb_device)..."
	$(DD) if=$(usb_device) of=$(WORK_DIR)/`basename $(usb_device)`.mbr bs=512 count=1
	$(SFDISK) -d $(usb_device) > $(WORK_DIR)/`basename $(usb_device)`.sfdisk
	$(QUIET) $(ECHO) && $(ECHO)
	$(QUIET) $(ECHO) "### Creating new partition table on $(usb_device)..."
	$(DD) if=/dev/zero of=$(usb_device) bs=512 count=1
	$(ECHO) -e "1,20,L,*\n21,100,L\n121,30,L\n151,600,L\n" | $(SFDISK) $(usb_device)
	$(QUIET) $(ECHO) && $(ECHO)
	$(QUIET) $(ECHO) "### Waiting for the device nodes to appear..."
	$(SLEEP) 15
	$(QUIET) $(ECHO) && $(ECHO)
	$(QUIET) $(ECHO) "### Making new filesystems on $(usb_device)..."
	$(MKE2FS) -L esos_boot $(usb_device)1
	$(MKE2FS) -L esos_root $(usb_device)2
	$(MKE2FS) -L esos_conf $(usb_device)3
	$(MKE2FS) -L esos_logs $(usb_device)4
	$(QUIET) $(ECHO) && $(ECHO)
	$(QUIET) $(ECHO) "### Installing image..."
	$(MKDIR) $(MOUNT_DIR)
	$(MOUNT) -L esos_root $(MOUNT_DIR) 
	$(MKDIR) $(MOUNT_DIR)/boot
	$(MOUNT) -L esos_boot $(MOUNT_DIR)/boot
	cd $(CWD)/etc && $(FIND) . -depth | $(CPIO) -pmdvu $(IMAGE_DIR)/etc
	cd $(IMAGE_DIR) && $(FIND) . -depth | $(CPIO) -pmdvu $(MOUNT_DIR)
	$(WORK_DIR)/grub-install --root-directory=$(MOUNT_DIR) --no-floppy $(usb_device)
	$(SED) 's/@@esos_ver@@/$(esos_ver)/' $(CWD)/misc/grub.cfg > $(MOUNT_DIR)/boot/grub/grub.cfg
	$(LN) /usr/share/zoneinfo/UTC $(MOUNT_DIR)/etc/localtime
	$(INSTALL) $(CWD)/scripts/conf_sync.sh $(MOUNT_DIR)/usr/local/sbin/
	$(INSTALL) $(CWD)/scripts/archive_logs.sh $(MOUNT_DIR)/usr/local/sbin/
	$(ECHO) "ESOS - Enterprise Storage OS $(esos_ver)" > $(MOUNT_DIR)/etc/esos-release
	$(TOUCH) -d "1970-01-01 00:00:00" $(MOUNT_DIR)/etc/*
	$(CHOWN) -R root:root $(MOUNT_DIR)/*
	$(CHMOD) 600 $(MOUNT_DIR)/etc/shadow
	$(CHMOD) 600 $(MOUNT_DIR)/etc/crontab
	$(UMOUNT) $(MOUNT_DIR)/boot
	$(UMOUNT) $(MOUNT_DIR)
	$(QUIET) $(ECHO) && $(ECHO)
	$(QUIET) $(ECHO) "### All done; your ESOS USB drive should be ready to use!"

.PHONY: initramfs
initramfs:
	$(RM) $(INITRAMFS_DIR)/dev/*
	$(MKNOD) $(INITRAMFS_DIR)/dev/null c 1 3
	$(MKNOD) $(INITRAMFS_DIR)/dev/console c 5 1
	$(MKNOD) $(INITRAMFS_DIR)/dev/tty c 5 0
	$(INSTALL) $(CWD)/misc/initramfs_init $(INITRAMFS_DIR)/init
	$(LN) busybox $(INITRAMFS_DIR)/bin/sh
	cd $(INITRAMFS_DIR) && $(FIND) . -print0 |	\
	$(CPIO) --null -ov --format=newc |		\
	$(GZIP) > $(IMAGE_DIR)/boot/initramfs.cpio.gz


# clean - Remove all temporary files and clean/distclean each package source directory.
.PHONY: clean
clean: $(clean_targets)
	$(RM) $(INITRAMFS_DIR)
	$(RM) $(IMAGE_DIR)

$(clean_targets): target = $(subst clean-,,$(@))
$(clean_targets):
	$(RM) $(target)


# distclean - Remove everything including build configuration settings.
.PHONY: distclean
distclean: clean
	$(RM) $(WORK_DIR)
	$(RM) autom4te.cache
	$(RM) configure
	$(RM) config.status
	$(RM) config.log
	$(RM) Makefile


# fetch - Grab all required packages from distribution file repositories.
fetch: $(distfiles) $(no_fetch_pkg_1) $(no_fetch_pkg_2) ;

$(distfiles):
	$(WGET) -P $(DISTFILES_DIR) $(distfiles_repo)/$(notdir $(@))

$(no_fetch_pkg_1):
	$(QUIET) $(ECHO) "### Fetch restriction: $(notdir $(@))"
	$(QUIET) $(ECHO) "### Please download from '$(no_fetch_pkg_1_url)'"
	$(QUIET) $(ECHO) "### and place it in '$(DISTFILES_DIR)'."
	$(QUIET) exit 1

$(no_fetch_pkg_2):
	$(QUIET) $(ECHO) "### Fetch restriction: $(notdir $(@))"
	$(QUIET) $(ECHO) "### Please download from '$(no_fetch_pkg_2_url)'"
	$(QUIET) $(ECHO) "### and place it in '$(DISTFILES_DIR)'."
	$(QUIET) exit 1


# checksum - Verify checksums for all distribution files.
.PHONY: checksum
checksum: fetch
	$(QUIET) $(ECHO) "### Verifying MD5 checksums..."
	$(QUIET) cd $(DISTFILES_DIR) && $(MD5SUM) -c $(CWD)/CHECKSUM.MD5
	$(QUIET) $(ECHO) "### Verifying SHA256 checksums..."
	$(QUIET) cd $(DISTFILES_DIR) && $(SHA256SUM) -c $(CWD)/CHECKSUM.SHA256


# extract - Extract all of the previously downloaded packages/archives.
extract: fetch checksum $(tarball_src_dirs) ;

$(tarball_src_dirs): src_file = $(wildcard $(DISTFILES_DIR)/$(notdir $(@)).*)
$(tarball_src_dirs):
	$(MKDIR) $(BUILD_DIR)
	$(QUIET) if [ "$(suffix $(src_file))" = ".gz" ]; then \
	  $(TAR) xvfz $(src_file) -C $(BUILD_DIR); \
	elif [ "$(suffix $(src_file))" = ".bz2" ]; then \
	  $(TAR) xvfj $(src_file) -C $(BUILD_DIR); \
	else \
	  $(ECHO) "### Unhandled file extension: $(suffix $(src_file))"; \
	  exit 1; \
	fi


# build - Configure/compile/build all of the required projects.
.PHONY: build
build: image_setup $(build_targets) ;

.PHONY: image_setup
image_setup:
	$(MKDIR) $(IMAGE_DIR)/{etc,bin,sbin,dev,proc,sys,root,home}
	$(MKDIR) $(IMAGE_DIR)/boot/grub
	$(MKDIR) $(IMAGE_DIR)/mnt/{root,conf,logs}
	$(MKDIR) $(IMAGE_DIR)/lib/firmware
	$(MKDIR) $(IMAGE_DIR)/usr/{bin,sbin,libexec,lib}
	$(MKDIR) $(IMAGE_DIR)/usr/local/{bin,sbin}
	$(MKDIR) $(IMAGE_DIR)/opt/{bin,sbin,lib}
	$(INSTALL) -m 1777 -d $(IMAGE_DIR)/tmp
	$(MKDIR) $(IMAGE_DIR)/var/{spool,lock,run,state,cache,log,empty}
	$(INSTALL) -m 1777 -d $(IMAGE_DIR)/var/tmp
	$(INSTALL) -m 710 -d $(IMAGE_DIR)/var/cron
	$(INSTALL) -m 700 -d $(IMAGE_DIR)/var/cron/tabs
	$(LN) lib $(IMAGE_DIR)/lib64
	$(LN) lib $(IMAGE_DIR)/usr/lib64
	$(MKDIR) $(INITRAMFS_DIR)/{bin,sbin,proc,sys,dev}
	$(MKDIR) $(INITRAMFS_DIR)/mnt/{root,tmp}
	$(MKDIR) $(INITRAMFS_DIR)/usr/{bin,sbin}

$(addprefix scst_kernel,$(prod_suffix) $(debug_suffix)): linux_src = $(wildcard $(BUILD_DIR)/linux-*)
$(addprefix scst_kernel,$(prod_suffix) $(debug_suffix)): kernel_ver = $(subst linux-,,$(notdir $(linux_src)))
$(addprefix scst_kernel,$(prod_suffix) $(debug_suffix)): scst_src = $(wildcard $(BUILD_DIR)/scst-*)
$(addprefix scst_kernel,$(prod_suffix) $(debug_suffix)): kern_suffix = $(subst scst_kernel,,$(@))
$(addprefix scst_kernel,$(prod_suffix) $(debug_suffix)):
	### Kernel prerequisites for SCST
	if [ ! -d $(linux_src)/scst_exec_req_fifo.patch ]; \
	then \
	  $(PATCH) -d $(linux_src) -b -B $(linux_src)/scst_exec_req_fifo.patch/ \
	  -p1 < $(scst_src)/scst/kernel/scst_exec_req_fifo-3.2.patch; \
	fi
	if [ ! -d $(linux_src)/put_page_callback.patch ]; \
	then \
	  $(PATCH) -d $(linux_src) -b -B $(linux_src)/put_page_callback.patch/ \
	  -p1 < $(scst_src)/iscsi-scst/kernel/patches/put_page_callback-3.2.patch; \
	fi
	$(RM) $(linux_src)/drivers/scsi/qla2xxx
	$(LN) $(scst_src)/qla2x00t $(linux_src)/drivers/scsi/qla2xxx
	### Setup for prod or debug
	$(MAKE) --directory=$(linux_src) clean
	$(MAKE) --directory=$(linux_src) distclean
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) clean
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) extraclean
	if [ "$(@)" = "scst_kernel$(prod_suffix)" ]; then \
	  $(SED) 's/CONFIG_LOCALVERSION\=\"\"/CONFIG_LOCALVERSION\=\"$(prod_suffix)\"/' \
	  $(CWD)/misc/$(notdir $(linux_src)).config > $(linux_src)/.config; \
	  $(MAKE) --directory=$(scst_src) KDIR=$(linux_src) 2perf; \
	fi
	if [ "$(@)" = "scst_kernel$(debug_suffix)" ]; then \
	  $(SED) 's/CONFIG_LOCALVERSION\=\"\"/CONFIG_LOCALVERSION\=\"$(debug_suffix)\"/' \
	  $(CWD)/misc/$(notdir $(linux_src)).config > $(linux_src)/.config; \
	  $(MAKE) --directory=$(scst_src) KDIR=$(linux_src) 2debug; \
	fi
	### Build/install the Linux kernel
	$(MAKE) --directory=$(linux_src)
	$(INSTALL) $(linux_src)/arch/x86_64/boot/bzImage $(IMAGE_DIR)/boot/bzImage$(kern_suffix)
	$(MAKE) --directory=$(linux_src) INSTALL_MOD_PATH=$(IMAGE_DIR) modules_install
	### Build/install SCST core and target drivers
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) KVER=$(kernel_ver)$(kern_suffix) scst
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) KVER=$(kernel_ver)$(kern_suffix) DESTDIR=$(IMAGE_DIR) INSTALL_DIR_H=$(IMAGE_DIR)/usr/include/scst scst_install
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) KVER=$(kernel_ver)$(kern_suffix) qla
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) KVER=$(kernel_ver)$(kern_suffix) INSTALL_MOD_PATH=$(IMAGE_DIR) qla_install
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) KVER=$(kernel_ver)$(kern_suffix) iscsi
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) KVER=$(kernel_ver)$(kern_suffix) SBINDIR=$(IMAGE_DIR)/usr/sbin INSTALL_MOD_PATH=$(IMAGE_DIR) iscsi_install
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) KVER=$(kernel_ver)$(kern_suffix) srpt
	$(MAKE) --directory=$(scst_src) KDIR=$(linux_src) KVER=$(kernel_ver)$(kern_suffix) INSTALL_MOD_PATH=$(IMAGE_DIR) srpt_install
	### Done
	$(TOUCH) $(@)

busybox: glibc
	$(MAKE) --directory=$(src_dir) clean
	$(MAKE) --directory=$(src_dir) distclean
	$(SED) -e 's/.*CONFIG_STATIC.*/CONFIG_STATIC=y/' \
	$(CWD)/misc/$(notdir $(src_dir)).config > $(src_dir)/.config
	$(MAKE) --directory=$(src_dir)
	$(INSTALL) $(STRIP) $(src_dir)/busybox_unstripped $(WORK_DIR)/initramfs/bin/busybox
	$(MAKE) --directory=$(src_dir) clean
	$(MAKE) --directory=$(src_dir) distclean
	$(CP) $(CWD)/misc/$(notdir $(src_dir)).config $(src_dir)/.config
	$(MAKE) --directory=$(src_dir)
	$(INSTALL) $(STRIP) $(src_dir)/busybox_unstripped $(IMAGE_DIR)/bin/busybox
	$(INSTALL) -d $(IMAGE_DIR)/usr/share/udhcpc
	$(INSTALL) $(src_dir)/examples/udhcp/simple.script $(IMAGE_DIR)/usr/share/udhcpc/default.script
	$(TOUCH) $(@)

sysvinit: glibc
	$(MAKE) --directory=$(src_dir)/src SULOGINLIBS=-lcrypt
	$(MAKE) --directory=$(src_dir)/src ROOT=$(IMAGE_DIR) install
	$(TOUCH) $(@)

grub: glibc
	cd $(src_dir) && ./configure --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install-exec
	$(MAKE) --directory=$(src_dir)/grub-core DESTDIR=$(IMAGE_DIR) install-platformDATA
	$(SED) 's/^prefix=.*/prefix=$(subst /,\/,$(IMAGE_DIR)/usr)/' $(IMAGE_DIR)/usr/sbin/grub-install > $(WORK_DIR)/grub-install
	$(CHMOD) +x $(WORK_DIR)/grub-install
	$(TOUCH) $(@)

glibc:
	$(TOUCH) $(IMAGE_DIR)/etc/ld.so.conf
	$(MKDIR) $(WORK_DIR)/glibc-build
	cd $(WORK_DIR)/glibc-build && \
	CFLAGS="-O2 -U_FORTIFY_SOURCE" $(src_dir)/configure --prefix=/usr
	$(MAKE) --directory=$(WORK_DIR)/glibc-build
	$(MAKE) --directory=$(WORK_DIR)/glibc-build install_root=$(IMAGE_DIR) install
	$(TOUCH) $(@)

perl: glibc
	cd $(src_dir) && CFLAGS="" ./configure.gnu --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) test
	$(MAKE) --directory=$(src_dir) install.perl DESTDIR=$(IMAGE_DIR) INSTALLFLAGS="-f -o"
	$(TOUCH) $(@)

MegaCLI:
	$(MKDIR) $(WORK_DIR)/$(@)
	$(UNZIP) -o $(wildcard $(DISTFILES_DIR)/*$(@)*) -d $(WORK_DIR)/$(@)
	$(UNZIP) -o $(WORK_DIR)/$(@)/LINUX/MegaCliLin.zip -d $(WORK_DIR)/$(@)/MegaCliLin
	cd $(WORK_DIR)/$(@) && $(RPM2CPIO) $(WORK_DIR)/$(@)/MegaCliLin/MegaCli-*.rpm | $(CPIO) -idmv
	cd $(WORK_DIR)/$(@) && $(RPM2CPIO) $(WORK_DIR)/$(@)/MegaCliLin/Lib_Utils-*.rpm | $(CPIO) -idmv
	$(CP) $(WORK_DIR)/$(@)/opt/MegaRAID/MegaCli/MegaCli64 $(IMAGE_DIR)/opt/sbin/
	$(CP) $(WORK_DIR)/$(@)/opt/lsi/3rdpartylibs/libsysfs.so.2.0.2 $(IMAGE_DIR)/opt/lib/
	$(MKDIR) $(IMAGE_DIR)/opt/lsi/3rdpartylibs/x86_64
	$(LN) /opt/lib/libsysfs.so.2.0.2 $(IMAGE_DIR)/opt/lsi/3rdpartylibs/x86_64/libsysfs.so.2.0.2
	$(TOUCH) $(@)

qlogic_fw:
	$(CP) $(src_dir)/*.bin $(IMAGE_DIR)/lib/firmware/
	$(TOUCH) $(@)

scstadmin: scst_src = $(wildcard $(BUILD_DIR)/scst-*)
scstadmin: perl_mod = $(wildcard $(scst_src)/scstadmin/scstadmin/scst-*)
scstadmin: perl_lib = $(wildcard $(IMAGE_DIR)/usr/lib/perl5/5.*)
scstadmin: perl
	cd $(perl_mod) && PERL5LIB="$(perl_lib)" $(IMAGE_DIR)/usr/bin/perl Makefile.PL \
	PREFIX=/usr DESTDIR=$(IMAGE_DIR) PERL_LIB="$(perl_lib)" PERL_ARCHLIB="$(perl_lib)/x86_64-linux"
	$(MAKE) --directory=$(perl_mod) PERL5LIB="$(perl_lib)"
	$(MAKE) --directory=$(perl_mod) PERL5LIB="$(perl_lib)" install
	$(INSTALL) -m 755 $(scst_src)/scstadmin/scstadmin/scstadmin $(IMAGE_DIR)/usr/sbin/
	$(TOUCH) $(@)

openssh: glibc zlib openssl
	cd $(src_dir) && ./configure --prefix="" --exec-prefix=/usr --without-openssl-header-check
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install-files
	$(TOUCH) $(@)

vixie-cron: glibc
	$(MAKE) --directory=$(src_dir) all
	$(INSTALL) $(STRIP) -m 111 $(src_dir)/cron $(IMAGE_DIR)/usr/sbin/
	$(INSTALL) $(STRIP) -m 4111 $(src_dir)/crontab $(IMAGE_DIR)/usr/bin/
	$(TOUCH) $(@)

gcc: glibc
	$(MKDIR) $(WORK_DIR)/gcc-build
	cd $(WORK_DIR)/gcc-build && $(src_dir)/configure --prefix=/usr --disable-multilib \
	--disable-nls --disable-bootstrap --enable-languages=c,c++
	$(MAKE) --directory=$(WORK_DIR)/gcc-build all-target-libgcc
	$(MAKE) --directory=$(WORK_DIR)/gcc-build DESTDIR=$(IMAGE_DIR) install-target-libgcc
	$(MAKE) --directory=$(WORK_DIR)/gcc-build all-target-libstdc++-v3
	$(MAKE) --directory=$(WORK_DIR)/gcc-build DESTDIR=$(IMAGE_DIR) install-target-libstdc++-v3
	$(TOUCH) $(@)

openssl: glibc
	cd $(src_dir) && ./config shared --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) INSTALL_PREFIX=$(IMAGE_DIR) install_sw
	$(TOUCH) $(@)

zlib: glibc
	cd $(src_dir) && ./configure --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install
	$(TOUCH) $(@)

ncurses: glibc
	cd $(src_dir) && ./configure --prefix=/usr --with-shared
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install.libs
	$(TOUCH) $(@)

e2fsprogs: glibc
	$(MKDIR) $(WORK_DIR)/e2fsprogs-build
	cd $(WORK_DIR)/e2fsprogs-build && $(src_dir)/configure --prefix=/usr
	$(MAKE) --directory=$(WORK_DIR)/e2fsprogs-build
	$(MAKE) --directory=$(WORK_DIR)/e2fsprogs-build check
	$(MAKE) --directory=$(WORK_DIR)/e2fsprogs-build DESTDIR=$(IMAGE_DIR) install-progs-recursive
	$(TOUCH) $(@)

ssmtp: glibc openssl
	cd $(src_dir) && ./configure --enable-ssl --prefix="" --exec-prefix=/usr
	$(MAKE) --directory=$(src_dir) SSMTPCONFDIR=/etc CC="gcc $(LDFLAGS) -lcrypto"
	$(INSTALL) $(STRIP) -m 755 $(src_dir)/ssmtp $(IMAGE_DIR)/usr/sbin/
	$(LN) ssmtp $(IMAGE_DIR)/usr/sbin/sendmail
	$(TOUCH) $(@)

libibumad: glibc
	cd $(src_dir) && ./configure --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	#$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install-exec
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install
	#$(MKDIR) $(IMAGE_DIR)/usr/include/infiniband
	#$(INSTALL) -m 644 $(src_dir)/include/infiniband/umad.h $(IMAGE_DIR)/usr/include/infiniband/
	$(TOUCH) $(@)

libibverbs: glibc
	cd $(src_dir) && ./configure --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	#$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install-exec
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install
	#$(MKDIR) $(IMAGE_DIR)/usr/include/infiniband
	#$(INSTALL) -m 644 $(src_dir)/include/infiniband/arch.h \
	#$(src_dir)/include/infiniband/driver.h $(src_dir)/include/infiniband/kern-abi.h \
	#$(src_dir)/include/infiniband/opcode.h $(src_dir)/include/infiniband/verbs.h \
	#$(src_dir)/include/infiniband/sa-kern-abi.h $(src_dir)/include/infiniband/sa.h \
	#$(src_dir)/include/infiniband/marshall.h $(IMAGE_DIR)/usr/include/infiniband/
	$(TOUCH) $(@)

srptools: glibc libibumad libibverbs
	cd $(src_dir) && ./configure --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	#$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install-exec
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install
	$(TOUCH) $(@)

asm_linux:
	$(MKDIR) $(WORK_DIR)/$(@)
	$(TAR) xvfz $(wildcard $(DISTFILES_DIR)/$(@)*) -C $(WORK_DIR)/$(@)
	cd $(WORK_DIR)/$(@) && $(RPM2CPIO) $(WORK_DIR)/$(@)/manager/StorMan-*.x86_64.rpm | $(CPIO) -idmv
	$(CP) $(WORK_DIR)/$(@)/cmdline/arcconf $(IMAGE_DIR)/opt/sbin/
	$(CP) $(WORK_DIR)/$(@)/usr/StorMan/libstdc++.so.5 $(IMAGE_DIR)/opt/lib/
	$(TOUCH) $(@)

lsscsi: glibc
	cd $(src_dir) && ./configure --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install
	$(TOUCH) $(@)

sg3_utils: glibc
	cd $(src_dir) && ./configure --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install
	$(TOUCH) $(@)

groff: glibc gcc
	cd $(src_dir) && ./configure --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install
	$(LN) tbl $(IMAGE_DIR)/usr/bin/gtbl
	$(TOUCH) $(@)

kexec-tools: glibc
	cd $(src_dir) && LDFLAGS="$(LDFLAGS) --static" CPPFLAGS="" ./configure --prefix=/usr
	$(MAKE) --directory=$(src_dir)
	$(MAKE) --directory=$(src_dir) DESTDIR=$(IMAGE_DIR) install
	$(TOUCH) $(@)


